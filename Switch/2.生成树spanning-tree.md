# 生成树 spanning-tree

## 技术背景

接入层交换机单链路上联，存在单链路故障  
另一个问题的单点故障，如果任意一个汇聚设备宕机，将直接导致下联的接入网络挂掉。  

为了解决这个问题，我们会在物理链路增加冗余，但物理链路增加链路或者设备之后，可能会导致网络产生环路，这时候所有的设备都会接收到大量的垃圾广播，也在疯狂的发送广播，一般称为“广播风暴”，当广播风暴产生后，整个二层网络直接瘫痪。  

为了解决广播风暴的问题，我们引入了生成树技术。  

通过生成树协议，我们将某个物理端口在逻辑上进行block，从而实现物理链路上的冗余环境，从而阻止了环路的产生，避免了广播风暴。
当拓扑发生的时候，STP协议将会探测到这些变换，会自动调整接口的状态，从而适应网络拓扑的变化，实现链路冗余。  

## spanning-tree的几种协议

802.1D  
PVST+ CISCO私有协议，每个VLAN拥有一棵单独的生成树实例（思科设备默认开启的）  
802.1W RSTP（其他厂商默认开启的stp协议）  
802.1S MSTP  
PVRST+ CISCO私有，对RSTP的增强版  

## STP的操作

每个广播域选择一个根桥（根桥指的就是根交换机，在一个广播域里只有一台）  
每个非根桥上选择一个根端口（根端口一般都是指向根桥方向的）  
每个段选择一个指定端口  
选择一个非指定端口  

### 根桥的选举

每个广播域选择一个根桥  
交换机STP开启后发送BPDU，BPDU中包含桥优先级和桥的mac地址这个字段，所有的桥会先对比优先级，优先级的范围是0-65535，优先级使用4096的倍数，如果我们不去手动修改交换机的优先级，默认优先级是32768，手动修改的话，遵循规则修改为4096的倍数，最小设置为4096。  

### 根端口的选举

    根端口：具有最低根路径的接口  
    要考虑的因素：  
        最低根桥ID  
        到根桥的最低路径成本  
        最低的发送者网桥ID  
        最低的发送者端口ID  

### STP路径开销

link speed | Cost
--- | ---
10 Gb/s | 2
1 Gb/s | 4
100 Mb/s | 19
10Mb/s | 100

路径开销是接口cos累加，而cost是基于带宽的

### 指定端口的选举

    指定端口：具有最低根路径的接口
    要考虑的因素：
        最低根桥ID
        到根桥的最低路径成本
        最低的发送者网桥ID
        最低的发送者端口ID

### STP的规则

当根桥、根端口和指定端口都选举完毕，我们将非指定端口直接变为阻塞状态，从而解决广播风暴的问题  

## 端口的几种状态

1.Disable：不收发任何报文  
2.Blocking：不接受也不转发帧，接收但不发送BPDU，不学习mac地址  
3.Listening：不接受也不转发帧，接收并且发送BPDU，不学习mac地址  
4.Learing：接收并且发送BPDU，学习mac地址  
5.Forwarding：接收并转发帧，接收并发送BPDU,学习mac地址  
